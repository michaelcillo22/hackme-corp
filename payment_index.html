<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Online Payment</title>
  <link rel="stylesheet" href="public/css/style.css" />
</head>
<body>
  <div class="container">
    <form id="paymentForm" action="#">
      <div class="row">
        <div class="col">
          <h3 class="title">Billing Address</h3>
          <div class="inputBox">
            <label for="name">Full Name:</label>
            <input type="text" id="name" placeholder="Enter your full name" required />
          </div>
          <div class="inputBox">
            <label for="email">Email:</label>
            <input type="text" id="email" placeholder="Enter email address" required />
          </div>
          <div class="inputBox">
            <label for="address">Address:</label>
            <input type="text" id="address" placeholder="Enter address" required />
          </div>
          <div class="inputBox">
            <label for="city">City:</label>
            <input type="text" id="city" placeholder="Enter city" required />
          </div>
          <div class="flex">
            <div class="inputBox">
              <label for="state">State:</label>
              <input type="text" id="state" placeholder="Enter state" required />
            </div>
            <div class="inputBox">
              <label for="zip">Zip Code:</label>
              <input type="number" id="zip" placeholder="123 456" required />
            </div>
          </div>
        </div>
        
        <div class="col">
          <h3 class="title">Payment</h3>
          <div class="inputBox">
            <label for="name">Card Accepted:</label>
            <img src="https://media.geeksforgeeks.org/wp-content/uploads/20240715140014/Online-Payment-Project.webp" alt="credit/debit card image" />
          </div>
          <div class="inputBox">
            <label for="cardName">Name On Card:</label>
            <input type="text" id="cardName" placeholder="Enter card name" required />
          </div>
          <div class="inputBox">
            <label for="cardNum">Credit Card Number:</label>
            <input type="text" id="cardNum" placeholder="1111-2222-3333-4444" maxlength="19" required />
          </div>
          <div class="inputBox">
            <label for="expDate">Expiration Date:</label>
            <input type="text" id="expDate" placeholder="MM/YYYY" maxlength="7" required />
          </div>
          <div class="flex">
            <div class="inputBox">
              <label for="cvv">CVV:</label>
              <input type="number" id="cvv" placeholder="123" required />
            </div>
          </div>
        </div>
      </div>
      <input type="submit" value="Proceed to Checkout" class="submit_btn" />
    </form>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", async () => {
    try {
      const response = await fetch(`/users/${userId}`); 
      const userData = await response.json();
      console.log("User:", userData);
    } catch (error) {
      console.error("Error searching for user:", error);
    }
  });

  const paymentForm = document.getElementById("paymentForm");
  const cardNumInput = document.getElementById("cardNum");
  const expDateInput = document.getElementById("expDate");

  cardNumInput.addEventListener("keyup", () => {
    let cardNum = cardNumInput.value.replace(/\D/g, "");
    if (cardNum.length > 0) {
      cardNum = cardNum.match(/.{1,4}/g)?.join("-") || cardNum;
      cardNumInput.value = cardNum;
    }
  });

  expDateInput.addEventListener("input", () => {
    let expDate = expDateInput.value.replace(/\D/g, "");

    if (expDate.length >= 2) {
      let month = expDate.substring(0, 2);
      if (Number(month) < 1 || Number(month) > 12) {
        alert("Please enter a valid month in mm format.");
        expDateInput.value = "";
        return;
      }
      expDate = month + "/" + expDate.substring(2, 6);
    }

    if (expDate.length === 7) {
      let currentYear = new Date().getFullYear();
      let inputYear = Number(expDate.substring(3, 7));
      let maxYear = currentYear + 10;

      if (inputYear < currentYear || inputYear > maxYear) {
        alert(`Expiration year must be between ${currentYear} and ${maxYear}.`);
        expDateInput.value = "";
        return;
      }
    }
  });

  // Submit Form
  paymentForm.addEventListener("submit", async (event) => {
    event.preventDefault();

    const userId = document.getElementById("userId").value; 
    const cardNum = cardNumInput.value;
    const expDate = expDateInput.value;
    const cvv = document.getElementById("cvv").value;

    const email = document.getElementById("email").value;
    const emailRegex = /^[^ ]+@[^ ]+\.[a-z]{2,3}$/;
    const cardRegex = /^\d{4}-\d{4}-\d{4}-\d{4}$/;
    const cvvRegex = /^\d{3,4}$/;

    let valid = true;

    // validate email, card, cvv
    if (!emailRegex.test(email)) {
      alert("Please enter a valid email.");
      valid = false;
    }
    if (!cardRegex.test(cardNum)) {
      alert("Credit card number must be in format: 1111-2222-3333-4444.");
      valid = false;
    }
    if (!cvvRegex.test(cvv)) {
      alert("CVV must be 3 or 4 digits.");
      valid = false;
    }

    if (!valid) {
      return; 
    }

    // Payment details for checkout
    const paymentData = {
      cardNumber: cardNum,
      expirationDate: expDate,
      cvv: cvv,
      billingAddress: {
        name: document.getElementById("name").value,
        email: email,
        address: document.getElementById("address").value,
        city: document.getElementById("city").value,
        state: document.getElementById("state").value,
        zip: document.getElementById("zip").value,
      }
    };

    try {
      const response = await fetch("/checkout/confirm", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({userId, paymentData}),
      });

      const result = await response.json();

      if (response.ok) {
        alert("Payment Successful! Your order has been placed.");
      } else {
        alert(`Error: ${result.error}`);
      }
    } catch (error) {
      console.error("Payment error:", error);
      alert("An error occurred while processing the payment.");
    }
  });
</script>
</body>
</html>